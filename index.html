<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>FPS Three.js V2 - Arme + Tirs + Textures</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; font-family: Arial; }
    #blocker {
      position: absolute; inset: 0; background: rgba(0,0,0,0.9);
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      color: white; text-align: center; z-index: 1000;
    }
    #instructions {
      cursor: pointer; padding: 30px; background: #222; border-radius: 15px; max-width: 500px;
    }
    #crosshair {
      position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; margin: -10px;
      pointer-events: none; opacity: 0;
    }
    #crosshair::before, #crosshair::after {
      content: ''; position: absolute; background: lime; left: 50%; top: 50%;
      transform: translate(-50%, -50%);
    }
    #crosshair::before { width: 2px; height: 20px; }
    #crosshair::after { width: 20px; height: 2px; }
    #ui {
      position: absolute; bottom: 20px; left: 20px; color: white; background: rgba(0,0,0,0.7); padding: 10px; border-radius: 5px; z-index: 100;
    }
    #debug {
      position: absolute; top: 10px; left: 10px; color: #0f0; font-size: 12px; background: rgba(0,0,0,0.7); padding: 5px; border-radius: 5px; z-index: 100;
    }
  </style>
</head>
<body>

  <div id="blocker">
    <div id="instructions">
      <h2>CLIQUE POUR JOUER</h2>
      <p><strong>ZQSD</strong> = bouger | <strong>Souris</strong> = viser | <strong>Clic gauche</strong> = tirer | <strong>R</strong> = recharger</p>
    </div>
  </div>
  <div id="crosshair"></div>
  <div id="ui">Munitions: <span id="ammo">30/30</span></div>
  <div id="debug">Chargement...</div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/controls/PointerLockControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/audio/AudioListener.js"></script>

  <script>
    if (typeof THREE === 'undefined') {
      document.getElementById('debug').textContent = 'ERREUR: Three.js non chargé';
      throw new Error('Three.js failed to load');
    }
    document.getElementById('debug').textContent = 'Three.js OK';

    // === SCÈNE ===
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb);
    scene.fog = new THREE.Fog(0x87ceeb, 10, 50);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1.6, 5);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    document.body.appendChild(renderer.domElement);

    // === AUDIO ===
    const listener = new THREE.AudioListener();
    camera.add(listener);

    // === CONTRÔLES ===
    const controls = new THREE.PointerLockControls(camera, renderer.domElement);
    const blocker = document.getElementById('blocker');
    const instructions = document.getElementById('instructions');
    const crosshair = document.getElementById('crosshair');

    instructions.addEventListener('click', () => controls.lock());
    controls.addEventListener('lock', () => {
      blocker.style.display = 'none';
      crosshair.style.opacity = '1';
      document.getElementById('debug').textContent = 'JEU ACTIF';
    });
    controls.addEventListener('unlock', () => {
      blocker.style.display = 'block';
      crosshair.style.opacity = '0';
    });

    // === TEXTURES RÉELLES ===
    const loader = new THREE.TextureLoader();
    const wallTexture = loader.load('https://threejs.org/examples/textures/brick_diffuse.jpg'); // Exemple gratuit Three.js [](grok_render_citation_card_json={"cardIds":["b2b1ae"]})
    wallTexture.wrapS = wallTexture.wrapT = THREE.RepeatWrapping;
    wallTexture.repeat.set(4, 1);
    const floorTexture = loader.load('https://threejs.org/examples/textures/hardwood2_diffuse.jpg'); // Exemple gratuit Three.js [](grok_render_citation_card_json={"cardIds":["1e216a"]})
    floorTexture.wrapS = floorTexture.wrapT = THREE.RepeatWrapping;
    floorTexture.repeat.set(10, 10);

    // === SOL ===
    const floor = new THREE.Mesh(
      new THREE.PlaneGeometry(50, 50),
      new THREE.MeshStandardMaterial({ map: floorTexture })
    );
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);

    // === LUMIÈRE ===
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const light = new THREE.DirectionalLight(0xffffff, 0.8);
    light.position.set(10, 20, 10);
    light.castShadow = true;
    scene.add(light);

    // === MURS AVEC TEXTURES ===
    const wallMat = new THREE.MeshStandardMaterial({ map: wallTexture });
    const walls = [];
    function addWall(x, z, w, d) {
      const wall = new THREE.Mesh(new THREE.BoxGeometry(w, 3, d), wallMat);
      wall.position.set(x, 1.5, z);
      wall.castShadow = wall.receiveShadow = true;
      scene.add(wall);
      walls.push(wall);
    }
    addWall(0, 0, 12, 1);
    addWall(6, 6, 1, 12);
    addWall(-6, 6, 1, 12);
    addWall(0, 12, 12, 1);

    // === ARME (SPRITE 2D pour simplicité) ===
    const gunSprite = loader.load('https://opengameart.org/sites/default/files/gun_sprite_preview.png'); // Exemple gratuit OpenGameArt [](grok_render_citation_card_json={"cardIds":["233013"]})
    const gunMaterial = new THREE.SpriteMaterial({ map: gunSprite });
    const gun = new THREE.Sprite(gunMaterial);
    gun.position.set(0.3, -0.3, -0.5);
    gun.scale.set(0.5, 0.5, 1);
    camera.add(gun);

    // === SONS ===
    const shootSound = new THREE.Audio(listener);
    shootSound.setBuffer(new THREE.AudioLoader().load('https://freesound.org/data/previews/387/387182_4187614-lq.mp3')); // Exemple gratuit Freesound pour tir [](grok_render_citation_card_json={"cardIds":["76e961"]})
    const reloadSound = new THREE.Audio(listener);
    reloadSound.setBuffer(new THREE.AudioLoader().load('https://freesound.org/data/previews/155/15545_15545-lq.mp3')); // Exemple gratuit Freesound pour reload [](grok_render_citation_card_json={"cardIds":["c539d4"]})

    // === TIRS ===
    const bullets = [];
    const ammo = 30;
    let currentAmmo = 30;
    let isReloading = false;

    function updateAmmoUI() {
      document.getElementById('ammo').textContent = `${currentAmmo}/30`;
    }

    function shoot() {
      if (currentAmmo <= 0 || isReloading) return;
      currentAmmo--;
      updateAmmoUI();

      // Son
      shootSound.play();

      // Balle
      const bulletGeo = new THREE.SphereGeometry(0.05);
      const bulletMat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
      const bullet = new THREE.Mesh(bulletGeo, bulletMat);
      bullet.position.copy(camera.position);
      const direction = new THREE.Vector3();
      camera.getWorldDirection(direction);
      bullet.velocity = direction.multiplyScalar(50);
      scene.add(bullet);
      bullets.push(bullet);
    }

    document.addEventListener('click', shoot);

    // Rechargement
    document.addEventListener('keydown', (e) => {
      if (e.code === 'KeyR' && currentAmmo < 30 && !isReloading) {
        isReloading = true;
        reloadSound.play();
        setTimeout(() => {
          currentAmmo = 30;
          updateAmmoUI();
          isReloading = false;
        }, 2000);
      }
    });

    // === MOUVEMENT ===
    const move = { forward: false, backward: false, left: false, right: false };
    const speed = 10;

    document.addEventListener('keydown', e => {
      if (e.code === 'KeyW') move.forward = true;
      if (e.code === 'KeyS') move.backward = true;
      if (e.code === 'KeyA') move.left = true;
      if (e.code === 'KeyD') move.right = true;
    });
    document.addEventListener('keyup', e => {
      if (e.code === 'KeyW') move.forward = false;
      if (e.code === 'KeyS') move.backward = false;
      if (e.code === 'KeyA') move.left = false;
      if (e.code === 'KeyD') move.right = false;
    });

    // === COLLISION JOUEUR ===
    function checkCollision() {
      const playerBox = new THREE.Box3().setFromObject(camera);
      for (const wall of walls) {
        if (playerBox.intersectsBox(new THREE.Box3().setFromObject(wall))) return true;
      }
      return false;
    }

    // === BOUCLE ===
    const clock = new THREE.Clock();
    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();

      // Mouvement joueur
      if (controls.isLocked) {
        const direction = new THREE.Vector3();
        if (move.forward) direction.z -= 1;
        if (move.backward) direction.z += 1;
        if (move.left) direction.x -= 1;
        if (move.right) direction.x += 1;
        direction.normalize();

        const velocity = direction.multiplyScalar(speed * delta);
        const oldPos = camera.position.clone();

        controls.moveRight(velocity.x);
        controls.moveForward(velocity.z);

        if (checkCollision()) camera.position.copy(oldPos);
      }

      // Mouvement balles
      bullets.forEach((bullet, i) => {
        bullet.position.add(bullet.velocity.clone().multiplyScalar(delta));
        if (bullet.position.length() > 100) {
          scene.remove(bullet);
          bullets.splice(i, 1);
        }
      });

      renderer.render(scene, camera);
    }

    animate();
    updateAmmoUI();
    document.getElementById('debug').textContent = 'Prêt ! Clique pour jouer.';

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>